# 项目背景
这个项目的名字叫做DNFAutoFire，简称DAF。
这是一个使用AutoHotkey v2.0编写的脚本，主要用于实现针对地下城与勇士（简称DNF）的按键连发功能，以及一些辅助按键功能。

# 项目需求
1. 具有一个主窗口，窗口上有一个类似键盘的区域，区域里的按键可以显示出键盘对应键位的连发启动状态。
2. 可以存取多个配置，并且具有全局快捷键可以唤出快捷切换窗口。
3. 实现连发功能，指键盘某个按键按住时，脚本自动连续重复发送按下抬起到游戏窗口。
4. 连发功能仅对DNF游戏生效，其他窗口不生效（判断当前激活的窗口是否为dnf.exe）
5. 连发功能使用SendInput，以vkFFscXX的格式发送虚拟码和扫描码结合的键值，这样可以避免影响到输入法的输入。
6. 连发功能支持多个按键独立触发，并且同时运行互不影响，比如同时按住J和L，那么J和L会同时在连发，游戏窗口会同时接收到J和L的连发按下抬起事件，然后仅释放J的时候，仅J的连发停止，L的连发依旧继续。其他键也是如此。

# 第一版技术记录

## 多进程架构
- 主进程负责按键监听和状态管理
- 每个按键使用独立的子进程处理连发
- 启动时就创建所有子进程，避免运行时创建/销毁
- 使用 `A_IconHidden := true` 隐藏子进程托盘图标

## 进程间通信
- 使用 Windows 共享内存（CreateFileMapping/MapViewOfFile）实现快速的进程间通信
- 每个按键占用一个字节的内存空间，通过偏移量访问
- 使用 RtlFillMemory 快速写入状态
- 使用 NumGet 快速读取状态

## 按键处理
- 使用 vkFFscXX 格式发送虚拟键码和扫描码
- 通过 2ms 的按下和抬起间隔实现连发
- 仅在 DNF 窗口激活时发送按键
- 非 DNF 窗口时保持原有按键功能

## 性能优化
- 使用 DllCall("Sleep") 实现精确的时间控制
- 非活动状态时使用较长的休眠时间（50ms）降低 CPU 占用
- 避免文件 I/O 操作
- 使用直接内存访问保证状态同步速度

## 资源管理
- 程序启动时初始化共享内存和子进程
- 使用 OnExit 回调确保资源正确清理
- 子进程自行管理内存映射的生命周期

这些技术要点确保了：
- 稳定的多按键并行连发
- 快速的状态响应
- 低资源占用
- 可靠的进程管理
- 精确的时间控制